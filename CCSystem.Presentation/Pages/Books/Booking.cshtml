@page
@model CCSystem.Presentation.Pages.BookingModel
@{
    ViewData["Title"] = "Bookings";
}

<h3>Your Booking</h3>
<div class="container p-4" style="border: none; border-radius: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
    <form method="post" asp-page="/Books/Booking" id="bookingForm">
        <input type="hidden" id="selectedServicesJson" name="SelectedServicesJson" value="@Model.SelectedServicesJson" />

        <div class="form-group">
            <label>Promotion Code</label>
            <input asp-for="BookingRequest.PromotionCode" class="form-control" />
        </div>
        <div class="form-group">
            <label>Notes</label>
            <textarea asp-for="BookingRequest.Notes" class="form-control"></textarea>
        </div>
        <div class="form-group">
            <label>Payment Method</label>
            <input asp-for="BookingRequest.PaymentMethod" class="form-control" />
        </div>
        <div class="form-group">
            <label>Address</label>
            <input asp-for="BookingRequest.Address" class="form-control" />
        </div>

        <h4>Selected Services</h4>
        @if (Model.SelectedServices.Any())
        {
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Option Name</th>
                        <th>Price</th>
                        <th>Duration</th>
                        <th>Schedule Date</th>
                        <th>Schedule Time</th>
                        <th>Quantity</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.SelectedServices.Count; i++)
                    {
                        var serviceDetail = Model.SelectedServices[i];
                        <tr>
                            <td>@serviceDetail.OptionName</td>
                            <td>@(serviceDetail.BasePrice?.ToString("C") ?? "N/A")</td>
                            <td>@(serviceDetail.Duration.HasValue ? $"{serviceDetail.Duration} minutes" : "N/A")</td>
                            <td>
                                <input asp-for="BookingRequest.BookingDetails[i].ScheduleDate"
                                       class="form-control"
                                       type="date"
                                       asp-format="{0:yyyy-MM-dd}"
                                       pattern="\d{4}-\d{2}-\d{2}"
                                       min="@DateTime.Now.ToString("yyyy-MM-dd")"
                                       required />
                            </td>
                            <td>
                                <input asp-for="BookingRequest.BookingDetails[i].ScheduleTime"
                                       class="form-control"
                                       type="time"
                                       step="1"
                                       pattern="\d{2}:\d{2}"
                                       required />
                            </td>
                            <td>
                                <input asp-for="BookingRequest.BookingDetails[i].Quantity"
                                       class="form-control"
                                       type="number"
                                       min="1"
                                       value="1"
                                       required />
                            </td>
                            <input type="hidden" asp-for="BookingRequest.BookingDetails[i].ServiceId" value="@serviceDetail.ServiceId" />
                            <input type="hidden" asp-for="BookingRequest.BookingDetails[i].ServiceDetailId" value="@serviceDetail.ServiceDetailId" />
                        </tr>
                    }
                </tbody>
            </table>
            <h5>Total Amount: @Model.TotalAmount.ToString("C")</h5>
        }
        else
        {
            <p>No services selected yet.</p>
        }

        <!-- Nút quay lại chọn thêm dịch vụ -->
        <button type="submit" asp-page-handler="AddDetail" class="btn btn-warning" onclick="updateLocalStorage()">Choose More Services</button>
        <button type="submit" class="btn btn-primary" onclick="updateLocalStorage()">Create Booking</button>
    </form>
</div>

<script>
    var storedServices = JSON.parse(localStorage.getItem('selectedServices')) || [];
    var serverServices = '@Html.Raw(Model.SelectedServicesJson)';
    var selectedServices = serverServices ? JSON.parse(serverServices) : storedServices;
    document.getElementById('selectedServicesJson').value = JSON.stringify(selectedServices);

    function updateLocalStorage() {
        var currentServices = JSON.parse(document.getElementById('selectedServicesJson').value || '[]');
        localStorage.setItem('selectedServices', JSON.stringify(currentServices));
    }
</script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}